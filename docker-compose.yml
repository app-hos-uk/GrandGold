version: '3.8'

services:
  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: grandgold-postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      POSTGRES_DB: grandgold_dev
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./infrastructure/docker/init-db.sql:/docker-entrypoint-initdb.d/01-init.sql
      - ./infrastructure/docker/02-create-cms-db.sql:/docker-entrypoint-initdb.d/02-create-cms-db.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - grandgold-network

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: grandgold-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - grandgold-network

  # Meilisearch
  meilisearch:
    image: getmeili/meilisearch:v1.6
    container_name: grandgold-meilisearch
    environment:
      MEILI_MASTER_KEY: grandgold_dev_key
      MEILI_NO_ANALYTICS: true
    ports:
      - "7700:7700"
    volumes:
      - meilisearch_data:/meili_data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7700/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - grandgold-network

  # Auth Service
  auth-service:
    build:
      context: .
      dockerfile: ./services/auth-service/Dockerfile
    container_name: grandgold-auth-service
    environment:
      NODE_ENV: development
      DATABASE_URL: postgresql://postgres:password@postgres:5432/grandgold_dev
      REDIS_URL: redis://redis:6379
      JWT_SECRET: dev-jwt-secret-change-in-production
      PORT: 4001
    ports:
      - "4001:4001"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - grandgold-network
    volumes:
      - ./services/auth-service:/app/services/auth-service
      - ./packages:/app/packages
      - /app/node_modules
      - /app/services/auth-service/node_modules

  # Seller Service
  seller-service:
    build:
      context: .
      dockerfile: ./services/seller-service/Dockerfile
    container_name: grandgold-seller-service
    environment:
      NODE_ENV: development
      DATABASE_URL: postgresql://postgres:password@postgres:5432/grandgold_dev
      REDIS_URL: redis://redis:6379
      PORT: 4002
    ports:
      - "4002:4002"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - grandgold-network

  # Fintech Service
  fintech-service:
    build:
      context: .
      dockerfile: ./services/fintech-service/Dockerfile
    container_name: grandgold-fintech-service
    environment:
      NODE_ENV: development
      DATABASE_URL: postgresql://postgres:password@postgres:5432/grandgold_dev
      REDIS_URL: redis://redis:6379
      PORT: 4003
    ports:
      - "4003:4003"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - grandgold-network

  # Order Service
  order-service:
    build:
      context: .
      dockerfile: ./services/order-service/Dockerfile
    container_name: grandgold-order-service
    environment:
      NODE_ENV: development
      DATABASE_URL: postgresql://postgres:password@postgres:5432/grandgold_dev
      REDIS_URL: redis://redis:6379
      PORT: 4004
    ports:
      - "4004:4004"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - grandgold-network

  # Payment Service
  payment-service:
    build:
      context: .
      dockerfile: ./services/payment-service/Dockerfile
    container_name: grandgold-payment-service
    environment:
      NODE_ENV: development
      DATABASE_URL: postgresql://postgres:password@postgres:5432/grandgold_dev
      REDIS_URL: redis://redis:6379
      PORT: 4005
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY}
      RAZORPAY_KEY_ID: ${RAZORPAY_KEY_ID}
      RAZORPAY_KEY_SECRET: ${RAZORPAY_KEY_SECRET}
    ports:
      - "4005:4005"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - grandgold-network

  # Product Service
  product-service:
    build:
      context: .
      dockerfile: ./services/product-service/Dockerfile
    container_name: grandgold-product-service
    environment:
      NODE_ENV: development
      REDIS_URL: redis://redis:6379
      MEILISEARCH_URL: http://meilisearch:7700
      MEILISEARCH_MASTER_KEY: grandgold_dev_key
      PORT: 4007
    ports:
      - "4007:4007"
    depends_on:
      redis:
        condition: service_healthy
      meilisearch:
        condition: service_healthy
    networks:
      - grandgold-network

  # Inventory Service
  inventory-service:
    build:
      context: .
      dockerfile: ./services/inventory-service/Dockerfile
    container_name: grandgold-inventory-service
    environment:
      NODE_ENV: development
      REDIS_URL: redis://redis:6379
      PORT: 4008
    ports:
      - "4008:4008"
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - grandgold-network

  # KYC Service
  kyc-service:
    build:
      context: .
      dockerfile: ./services/kyc-service/Dockerfile
    container_name: grandgold-kyc-service
    environment:
      NODE_ENV: development
      DATABASE_URL: postgresql://postgres:password@postgres:5432/grandgold_dev
      REDIS_URL: redis://redis:6379
      PORT: 4006
    ports:
      - "4006:4006"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - grandgold-network

  # Web Frontend
  web:
    build:
      context: .
      dockerfile: ./apps/web/Dockerfile
    container_name: grandgold-web
    environment:
      NODE_ENV: development
      NEXT_PUBLIC_API_URL: http://localhost:4000
    ports:
      - "3000:3000"
    depends_on:
      - auth-service
    networks:
      - grandgold-network
    volumes:
      - ./apps/web:/app/apps/web
      - ./packages:/app/packages
      - /app/node_modules
      - /app/apps/web/node_modules

  # API Gateway (optional - for development can use direct service calls)
  # api-gateway:
  #   image: nginx:alpine
  #   container_name: grandgold-gateway
  #   ports:
  #     - "4000:80"
  #   volumes:
  #     - ./infrastructure/nginx/nginx.conf:/etc/nginx/nginx.conf
  #   depends_on:
  #     - auth-service
  #     - seller-service
  #     - order-service
  #   networks:
  #     - grandgold-network

  # AI Service (Vertex AI - Chat & Visual Search)
  ai-service:
    build:
      context: .
      dockerfile: ./services/ai-service/Dockerfile
    container_name: grandgold-ai-service
    environment:
      NODE_ENV: development
      PORT: 4009
      PRODUCT_SERVICE_URL: http://product-service:4007
      GCP_PROJECT_ID: ${GCP_PROJECT_ID:-}
      VERTEX_AI_LOCATION: ${VERTEX_AI_LOCATION:-us-central1}
      CORS_ORIGINS: http://localhost:3000
    ports:
      - "4009:4009"
    depends_on:
      - product-service
    networks:
      - grandgold-network

  # CMS Service (Strapi)
  cms-service:
    build:
      context: ./services/cms-service
      dockerfile: Dockerfile
    container_name: grandgold-cms
    environment:
      NODE_ENV: development
      HOST: 0.0.0.0
      PORT: 1337
      DATABASE_CLIENT: postgres
      DATABASE_HOST: postgres
      DATABASE_PORT: 5432
      DATABASE_NAME: grandgold_cms
      DATABASE_USERNAME: postgres
      DATABASE_PASSWORD: password
      APP_KEYS: grandgold-key-1,grandgold-key-2,grandgold-key-3,grandgold-key-4
      ADMIN_JWT_SECRET: grandgold-admin-jwt-secret
      API_TOKEN_SALT: grandgold-api-token-salt
      TRANSFER_TOKEN_SALT: grandgold-transfer-salt
      JWT_SECRET: grandgold-jwt-secret
      RUN_CMS_SEED: "true"
    ports:
      - "1337:1337"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - grandgold-network
    volumes:
      - ./services/cms-service:/app
      - /app/node_modules
      - cms_uploads:/app/public/uploads

volumes:
  postgres_data:
  redis_data:
  meilisearch_data:
  cms_uploads:

networks:
  grandgold-network:
    driver: bridge
