# Production: 401 Login, 404 API, 500 Search

When the **production** web app (`https://web-xxx.run.app`) shows **401**, **404**, or **500** on API calls, use this runbook.

---

## Why production still has these errors

The web app is just the frontend. All `/api/*` requests are **rewritten at build time** to backend services (auth, seller, kyc, payment, product, etc.). So:

1. **You must deploy the backend services** (auth, seller, kyc, payment, order, product, etc.) to Cloud Run.
2. **You must build the web app with the production backend URLs** (e.g. `NEXT_PUBLIC_AUTH_SERVICE_URL=https://auth-service-xxx.run.app`). If the web was built without these, or with wrong URLs, you get 404/502 or requests hitting the wrong service.
3. **After changing backend URLs or adding services**, you must **rebuild and redeploy the web** (URLs are baked in at build time).

So: **yes, you need to deploy your changes** — both backend services and a new web build that points at them.

---

## Error summary

| Error | Endpoint example | Likely cause | Fix |
|-------|------------------|--------------|-----|
| **401** | `POST /api/auth/login` | Auth service reached but rejected (wrong credentials or auth config) | See [401 Login](#401-unauthorized-on-login) |
| **404** | `/api/sellers/onboarding/pending`, `/api/kyc/pending`, `/api/payments/refunds`, `/api/influencers` | Web built with wrong backend URL or that service not deployed | See [404 Not Found](#404-on-sellers-kyc-payments) |
| **500** | `/api/search/admin`, `/api/promotions/coupons`, `/api/promotions/automatic`, `/api/promotions/flash-sales` | Backend threw (MeiliSearch down, promotion service not deployed, or unhandled error) | See [500 Internal Server Error](#500-on-search-or-product) |

---

## 401 Unauthorized on login

**Meaning:** The request reached the auth service, but it returned “Unauthorized”. So the problem is **not** “service not found” but **auth rejecting the request**.

Common causes:

1. **Wrong email/password**  
   Use the same credentials you use in production (e.g. Super Admin from seed). If you never seeded production, see [Login 500 runbook](./08-login-500-production.md) (Step 3b – seed production DB).

2. **Auth service env (JWT, DB, Redis)**  
   Auth needs correct production env in Cloud Run:
   - `JWT_SECRET` (same as other services that verify tokens)
   - `DATABASE_URL` (production DB; see runbook 08)
   - `REDIS_URL` (optional for MFA/session)

3. **User doesn’t exist in production DB**  
   Seed the production DB so the Super Admin (or test user) exists:
   ```bash
   export DATABASE_URL="$(gcloud secrets versions access latest --secret=grandgold-database-url --project=YOUR_PROJECT)"
   pnpm db:seed
   ```

**Check:** Call auth directly (replace with your URL):
```bash
curl -s -X POST https://auth-service-484382472654.asia-south1.run.app/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"your-admin@example.com","password":"YourPassword"}'
```
- **200 + tokens** → auth is fine; 401 in browser may be wrong credentials or cookie/origin.
- **401** → wrong credentials or user not in DB (seed production).
- **500** → use [08-login-500-production.md](./08-login-500-production.md).

---

## 404 on sellers, KYC, payments

**Meaning:** The web app is sending requests to a backend that doesn’t have that route. Often the **web image was built with the wrong service URLs** (e.g. KYC/Seller/Payment pointed at auth-service), so those paths hit auth and return 404.

**Fix:**

1. **Use the correct web build config**  
   The web must be built with the **correct** backend URLs:
   - `NEXT_PUBLIC_KYC_SERVICE_URL` → kyc-service URL  
   - `NEXT_PUBLIC_SELLER_SERVICE_URL` → seller-service URL  
   - `NEXT_PUBLIC_PAYMENT_SERVICE_URL` → payment-service URL  

   In this repo, `infrastructure/gcp/cloudbuild-web.yaml` has been updated so KYC, Seller, Fintech, and Payment point to their own services (not auth). Use that file (or the same build-args) when building the web image.

2. **Deploy backend services**  
   Ensure these are deployed (so the web’s rewrites resolve):
   - **KYC:** kyc-service → `/api/kyc/*` (e.g. `/api/kyc/pending`)
   - **Payments:** payment-service → `/api/payments/*` (e.g. `/api/payments/refunds`)
   - **Influencers:** product-service → `/api/influencers`, `/api/influencers/*`
   - **Promotions:** promotion-service → `/api/promotions/*` (coupons, automatic, flash-sales)

   ```bash
   export GCP_PROJECT_ID=grandmarketplace   # or your project
   pnpm gcp:deploy
   # deploy promotion if not in deploy-all:
   ./infrastructure/gcp/deploy-service.sh promotion-service asia-south1
   ```

3. **Rebuild and redeploy the web**  
   After fixing URLs and deploying backends, **rebuild the web image** with the correct build-args and redeploy the web service. URLs are fixed at build time, so a new build is required.

---

## 500 on search or product

**Meaning:** The request reached the product (or promotion) backend, but the server threw an error. Backend code has been hardened so `/api/search/admin` and `/api/promotions/*` list endpoints return 200 with empty data when MeiliSearch or promotion logic fails; if you still see 500, the request may be hitting a different service (wrong URL in web build) or an old image.

**Fix:**

1. **Check product-service or promotion-service logs** (replace project/region):
   ```bash
   gcloud run services logs read product-service --region=asia-south1 --project=grandmarketplace --limit=100
   ```
   Look for the error message and stack (e.g. DB connection, missing env, undefined).

2. **Ensure product-service has DATABASE_URL** (and any other required env) set in Cloud Run. If it uses the same DB as auth, use the same secret (e.g. `grandgold-database-url`).

3. **Redeploy product-service** after fixing env or code, then retry the request.

---

## Deploy checklist (fix 404/401/500)

1. **Backend services deployed**  
   auth, kyc, seller, fintech, order, payment, product, inventory (and optionally promotion, notification) are deployed to Cloud Run.

2. **Web built with production URLs**  
   Build web with `infrastructure/gcp/cloudbuild-web.yaml` (or same build-args as in that file), so each `/api/*` path goes to the right service.

3. **Production DB seeded**  
   So login user exists and product/search can read data.

4. **Auth env correct**  
   `DATABASE_URL`, `JWT_SECRET` (and optionally `REDIS_URL`) set on auth-service in Cloud Run.

5. **Redeploy web after any URL or backend change**  
   New image + deploy web so the new build is live.

---

## Quick redeploy (web with correct backends)

From project root, one command per block:

```bash
export GCP_PROJECT_ID=grandmarketplace
```

Build web with correct backend URLs (uses cloudbuild-web.yaml):

```bash
gcloud builds submit --config=./infrastructure/gcp/cloudbuild-web.yaml --timeout=20m .
```

Deploy web to Cloud Run:

```bash
gcloud run deploy web --image gcr.io/$GCP_PROJECT_ID/web --platform managed --region asia-south1 --allow-unauthenticated --quiet
```

If your project uses a **different project number** than `484382472654`, edit `infrastructure/gcp/cloudbuild-web.yaml` and replace `484382472654` with your project number (or use substitution in Cloud Build) so the web points at your real service URLs.
